<!DOCTYPE html>
<html>
<head>
    <title>Kidney AR - Guaranteed Working</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #permission-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 10000;
        }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- Permission Request -->
    <div id="permission-box">
        <h2>Camera Access Required</h2>
        <button onclick="startAR()">Allow Camera Access</button>
        <p id="error-msg" style="color: red; margin-top: 10px;"></p>
    </div>

    <!-- AR Scene -->
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" style="display: none;">
        <!-- Marker-based (for maximum compatibility) -->
        <a-marker preset="hiro">
            <a-entity gltf-model="https://cdn.glitch.global/df837afa-0dcd-45f4-8e2c-791d7c2a6358/kidney.glb"
                     scale="0.3 0.3 0.3"
                     animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
            </a-entity>
        </a-marker>
        
        <!-- Markerless (for newer devices) -->
        <a-entity camera></a-entity>
        <a-entity cursor="rayOrigin: mouse"></a-entity>
    </a-scene>

    <!-- Controls -->
    <div class="controls" style="display: none;">
        <input type="range" id="damage" min="0" max="100" value="0">
        <p>Damage Level: <span id="damage-value">0</span>%</p>
    </div>

    <script>
        // 1. Handle Camera Permissions
        async function startAR() {
            try {
                // Request camera access first
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                
                // Hide permission box
                document.getElementById('permission-box').style.display = 'none';
                
                // Show AR scene
                const scene = document.querySelector('a-scene');
                scene.style.display = 'block';
                
                // Show controls
                document.querySelector('.controls').style.display = 'block';

                // Start AR
                scene.addEventListener('loaded', () => {
                    // Add click handler for markerless AR
                    scene.addEventListener('click', (evt) => {
                        const entity = document.createElement('a-entity');
                        entity.setAttribute('gltf-model', 'https://cdn.glitch.global/df837afa-0dcd-45f4-8e2c-791d7c2a6358/kidney.glb');
                        entity.setAttribute('scale', '0.3 0.3 0.3');
                        entity.object3D.position.copy(evt.detail.intersection.point);
                        scene.appendChild(entity);
                    });
                });

            } catch (error) {
                document.getElementById('error-msg').textContent = 
                    `Error: ${error.message}. Please enable camera access in browser settings.`;
            }
        }

        // 2. Damage Visualization
        document.getElementById('damage').addEventListener('input', (e) => {
            const damage = e.target.value / 100;
            document.getElementById('damage-value').textContent = e.target.value;

            // Update all kidney models
            document.querySelectorAll('[gltf-model]').forEach(kidney => {
                // Color change (red to brown)
                kidney.setAttribute('material', 'color', `hsl(${30 - (damage * 30)}, 70%, 50%)`);
                
                // Size reduction
                const scale = 0.3 - (damage * 0.15);
                kidney.setAttribute('scale', `${scale} ${scale} ${scale}`);
                
                // Surface texture
                kidney.setAttribute('roughness', damage);
            });
        });

        // 3. Compatibility Check
        window.addEventListener('load', () => {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                document.getElementById('error-msg').textContent = 
                    'Webcam access not supported. Use Chrome/Firefox on Android or Safari on iOS.';
            }
        });
    </script>

    <!-- Instructions -->
    <div style="position: fixed; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.5); padding: 10px;">
        <strong>How to use:</strong><br>
        1. Click "Allow Camera Access"<br>
        2. Point camera at flat surface<br>
        3. Adjust slider to see damage
    </div>
</body>
</html>
